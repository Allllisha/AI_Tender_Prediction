1. 製品要求仕様書 (PRD) - 建築入札インテリジェンス・システム
   Ver. 1.3 (MVP - KKJ API版)

1. 概要
   1.1 目的
   全国の公共事業の入札情報を活用し、ゼネコンの営業担当者が勝てる可能性の高い案件を見極め、適切な入札金額を判断するための意思決定を支援すること。

1.2 解決する課題
全国の入札情報が様々なサイトに散在しており、横断的な検索が困難。

過去の落札データに基づいた客観的な価格分析に時間がかかる。

入札におけるリスク要因（競合の強さ、価格以外の評価点など）の把握が属人化している。

1.3 ターゲットユーザー
ゼネコンの営業部門、積算部門の担当者

2. スコープ
   2.1 対象範囲 (In Scope)
   全国の公共工事の入札前案件の横断検索

自社入札額に基づく勝率・リスクの予測と根拠の提示

検索条件の保存と新着案件の通知

分析結果の CSV/PDF 形式でのエクスポート

2.2 対象外 (Out of Scope)
民間発注の工事案件

入札参加のための書類作成ワークフロー

詳細な原価見積（あくまで落札価格の予測に特化）

3. 機能要件
   3.1 案件サーチ機能
   ユーザーは以下の条件を組み合わせて、入札前の案件を検索できる。

地域: 都道府県、市区町村（複数選択可）

規模: 延床面積（㎡）の範囲指定

時期: 入札日または公告日の期間指定

金額: 予定価格または最低制限価格の下限値

その他: 工事の用途（学校、庁舎など）、調達方式（一般競争、総合評価など）、JV（共同企業体）参加の可否

3.2 勝率・リスク予測機能
ユーザーは関心のある案件を選択する。

自社の入札予定金額を入力する。

システムは即時に以下の情報を出力する。

ランク評価: A ～ E の 5 段階で、入札額の妥当性を分かりやすく表示。

勝率: 72%のように具体的な勝率をパーセンテージで表示。

信頼度: 予測の信頼性を高・中・低で表示。

判断の根拠: 「類似案件 15 件の落札額中央値より 1,500 万円低い」など、予測の基になった客観的な事実。

主なリスク: 「地域の大手企業が過去の同種案件で高い勝率を誇る」など、注意すべきリスク要因を文章で説明。

補足: 予測には、**自社の過去の落札実績（勝ち案件）が考慮され、**特定地域や工事用途における強みが自動的に反映される。

3.3 一括予測機能
ユーザーは、案件を一つに絞らず、検索時と同じ条件（地域、規模、時期など）を指定する。

自社の入札単価（または総額）の基本方針を入力する。

システムは、指定条件に合致するすべての公開中案件に対して、一括でランクと勝率を算出してリスト表示する。これにより、最も「おいしい」案件群を効率的に見つけ出せる。

4. データ方針
   MVP（Minimum Viable Product）段階では、データの品質と開発速度を最優先し、官公需情報ポータルサイト（KKJ）APIに情報源を限定する。

MVP 対象: KKJ APIから提供される「公開中案件」および「落札結果」データ

将来拡張: GEPS、Data.go.jp、各自治体ポータルは、MVP 後のフェーズでカバレッジ拡大を目的として追加を検討する。

🛠️ 2. 技術設計書 (TDD) - 建築入札インテリジェンス・システム
Ver. 1.3 (MVP - KKJ API版)

1. システムアーキテクチャ
   1.1 構成図
   Azure App Service を中心としたサーバーレスアーキテクチャを採用し、スケーラビリティと運用効率を両立させる。

Roboconf

graph TD
subgraph "外部ソース"
DS_KKJ[KKJ API]
end

    subgraph "Azure"
        U[API利用者] --> API_APP[<b>App Service (API)</b><br>FastAPI / Python]

        subgraph "App Service Plan"
            API_APP
            ETL_JOB[<b>WebJob (ETL)</b><br>日次データ収集]
        end

        ETL_JOB --> DS_KKJ
        ETL_JOB --> PG[(<b>PostgreSQL</b><br>案件/結果データ)]
        ETL_JOB --> BLOB[(<b>Blob Storage</b><br>生データ保管)]

        API_APP --> PG
        API_APP --> REDIS[(<b>Cache for Redis</b><br>クエリ/類似集合キャッシュ)]
        API_APP --> OPENAI[(<b>Azure OpenAI</b><br>リスク説明生成)]
        API_APP --> KV[<b>Key Vault</b><br>シークレット管理]
        API_APP & ETL_JOB --> AI[<b>Application Insights</b><br>監視/ログ]

        ACR[<b>Container Registry</b><br>Dockerイメージ]
        GH[GitHub Actions] --> ACR --> API_APP & ETL_JOB
    end

1.2 コンポーネント解説
コンポーネント 役割
Azure App Service FastAPI で構築されたメイン API と、日次バッチ(WebJob)の実行環境。
Azure Database for PostgreSQL 正規化された入札案件、落札結果データを格納する RDB。
Azure Cache for Redis 検索結果や類似案件集合など、頻繁にアクセスされるデータをキャッシュし高速化。
Azure OpenAI 予測モデルの出力結果を基に、risk_notes（リスク説明文）を自然言語で動的生成。
Blob Storage 収集した生の XML/CSV ファイルや、ユーザーが出力したレポートを保管。
Key Vault DB 接続文字列、API キーなどのシークレット情報を安全に一元管理。
Container Registry CI/CD パイプラインでビルドした Docker イメージを保管。
Application Insights API パフォーマンス監視、エラー追跡、ログ分析。

Google スプレッドシートにエクスポート 2. API 仕様
2.1 エンドポイント一覧
GET /tenders/search: 案件検索

GET /tenders/{tender_id}: 案件詳細

POST /predict: 単一案件の勝率予測

POST /predict-from-params: 複数案件の一括勝率予測

2.2 詳細仕様
POST /predict

Request Body:

JSON

{
"tender_id": "kkj-2025-xxxx",
"bid_amount_jpy": 3480000000,
"company_profile": { "name": "〇〇建設株式会社" }
}
Response Body:

JSON

{
"rank": "B",
"win_prob": 0.68,
"win_prob_ci": [0.55, 0.80],
"confidence_level": "medium",
"basis": {
"n_similar": 12,
"unit_price_median_jpy_per_m2": 1320000,
"delta_jpy": -23000000
},
"risk_notes": [
"類似案件の中央値と比較して価格競争力は高いと判断されます。",
"ただし、自社の当該地域での過去の落札実績が少なく、ローカル企業の追い上げに注意が必要です。"
],
"top_factors": [
{"name": "price_gap", "direction": "+", "impact": 0.45},
{"name": "company_strength_in_area", "direction": "-", "impact": -0.15}
]
}
POST /predict-from-params

Request Body:

JSON

{
"search_params": {
"prefecture_code": ["13"],
"min_floor_area_m2": 2000,
"use": ["school"]
},
"bid_amount_jpy": 3480000000,
"company_profile": { "name": "〇〇建設株式会社" }
}
Response Body:

JSON

{
"predictions": [
{
"tender_id": "kkj-2025-xxxx",
"title": "〇〇中学校改修工事",
"rank": "B",
"win_prob": 0.68
},
{
"tender_id": "kkj-2025-yyyy",
"title": "△△ 小学校増築工事",
"rank": "C",
"win_prob": 0.45
}
]
} 3. データモデル (主要スキーマ)
tenders_open (公開中案件)
tender_id (PK), source, publisher, title, prefecture_code, municipality_code, address_text, use, method, jv_allowed, floor_area_m2, bid_date, notice_date, origin_url, last_seen_at

awards (落札結果)
award_id (PK), tender_id (FK), awardee_name_norm, award_amount_jpy, open_date, participants_count

4. 主要アルゴリズム
   4.1 予測プロセス概要
   類似集合の抽出: 当該案件の条件（地域・規模等）に基づき、過去の**「勝ち案件（落札結果）」のみ**を DB から抽出する。件数が不足する場合、地域 → 用途 → 方式の順に条件を緩和して再検索する。

基準単価の推定: 類似集合の落札額を面積単価（円/㎡）に正規化し、その中央値を「基準単価」とする。外れ値は IQR 法で除外。

価格差（Δ）の算出: Δ = 自社入札額 - (基準単価 × 当該案件の面積)

ランク判定: 算出した Δ を基に、ランクを A ～ E で判定する (詳細は 4.2)。

確率推定: Δ やその他特徴量から、機械学習モデルで具体的な勝率(win_prob)と信頼区間(win_prob_ci)を算出する (詳細は 4.3)。

不確実性評価: 予測の信頼性を評価し、警告などを付与する (詳細は 4.4)。

4.2 ランク判定 (A–E)
価格差 Δ に基づき、以下の初期しきい値でランクを分類する。このしきい値は、将来的に地域や規模帯ごとに自動最適化される。

A ランク (高勝率): Δ ≤ −50,000,000

B ランク (やや有利): −50,000,000 < Δ ≤ −20,000,000

C ランク (妥当圏): −20,000,000 < Δ ≤ +10,000,000

D ランク (やや不利): +10,000,000 < Δ ≤ +20,000,000

E ランク (低勝率): Δ > +20,000,000

4.3 確率推定（機械学習）
モデル: 説明性を担保するロジスティック回帰と、非線形な関係性を捉える LightGBM を組み合わせたスタッキングモデルを採用する。

特徴量:

price_gap: 基準単価 - 自社入札単価（価格的な優位性）

案件属性: 地域、用途、延床面積、工期、年度、調達方式、予定価格の有無

競争環境: 地域 × 方式別の過去の平均参加社数統計

発注者傾向: 発注者ごとの固定効果

自社強み: company_profile で指定された企業の過去落札実績から生成した固定効果 (詳細は 4.5)

学習と出力:

過去の入札データを、落札できたかどうかのラベルを付与して教師データとする。

時系列分割 (Time Series Split) を用いてモデルの汎化性能を正しく評価する。

モデルの出力確率を、Platt Scaling または Isotonic Regression で校正し、より信頼できる確率値に変換する。

最終的な出力として、勝率(win_prob)、信頼区間(win_prob_ci)、そして予測に寄与した要因（SHAP 値や係数から算出）を提示する。

4.4 不確実性管理
予測結果の過信を防ぎ、ユーザーの適切な意思決定を促すために、以下の管理を行う。

類似案件数の評価: n_similar（類似集合の件数）が事前に定めた閾値（例: 5 件）未満の場合、または落札額の分散が過大な場合、予測の信頼等級を Low とし、結果と共に警告メッセージを表示する。

信頼区間の提示: 常に勝率と共に信頼区間(win_prob_ci)を提示し、予測のばらつきを明示する。不確実性が高い場合は、この区間が広くなる。

4.5 自社強み補正（固定効果モデル）
目的: 企業ごとの得意・不得意をモデルに反映させる。

手法: 予測時、company_profile で指定された企業の過去の落札実績（勝ち案件）を API 経由で取得。その企業が「どの地域・用途・方式で勝ってきたか」を変数（固定効果）として ML モデルの特徴量に加える。これにより、同じ入札額でも、得意分野の案件であれば勝率が高く補正される。

4.6 Azure OpenAI 連携
/predict の最後に、予測モデルの出力（rank, win_prob, 寄与要因など）をインプットとして Azure OpenAI の Completion API を呼び出す。プロンプトエンジニアリングにより、これらの数値を解釈し、ユーザーに分かりやすい risk_notes（リスク説明文）を生成させる。

5. データ収集戦略
   5.1 MVP におけるデータ収集方針
   MVP 段階では、データソースを官公需情報ポータルサイト（KKJ）APIに一本化する。

取得対象: KKJ APIが提供する標準 XML 形式の「公開中案件」および「落札結果」データ。

利点:

APIアクセス可能: 認証不要で公開APIとして利用でき、安定したデータ収集が可能。

カテゴリフィルタ: Category=2パラメータで工事案件のみを簡単に絞り込める。

構造化データ: XML形式で項目名や形式が統一されており、パースが容易。

5.2 将来の拡張方針
MVP リリース後、さらなる案件カバレッジの拡大が必要となった場合、以下のデータソースを追加する。

GEPS（政府電子調達システム）

Data.go.jp（政府オープンデータ）

主要自治体のオープンデータポータル

この拡張フェーズにおいては、収集したデータから**「工事」カテゴリを抽出するフィルタリング処理と、各ソースの独自スキーマを標準モデルへ変換するマッピング処理**の実装が必須となる。
